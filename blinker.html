<script>
  /**
   * Load scripts function
   */
  function loadJS(FILE_URL, async = true) {
    let scriptEle = document.createElement("script");

    scriptEle.setAttribute("src", FILE_URL);
    scriptEle.setAttribute("type", "text/javascript");
    scriptEle.setAttribute("async", async);

    document.body.appendChild(scriptEle);

    // success event 
    scriptEle.addEventListener("load", () => {});

    // error event
    scriptEle.addEventListener("error", (ev) => {
      console.log("Error loading file: ", ev);
    });
  }

  // Add blinker css
  document.getElementsByTagName('head')[0].insertAdjacentHTML('beforeend', '<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/gpmd/blinker-theme@1.0.3/blinker.css" type="text/css" />');

  function initBlinker() {
    // Config
    const blinkerID = '4e91da36a69aac';
    const blogURL = '/journal/';
    const relatedPostsLimit = '3';
    const featuredPostsLimit = '3';
    const relatedProductsLimit = '4';

    // Do not change
    const blinkerAPIPostsURL = 'https://blinker.gpmd.net/posts?h=';
    const blinkerAPIFeaturedPostsURL = 'https://blinker.gpmd.net/featured?h=';
    const pageType = '{{page_type}}';

    getRelatedPosts(blinkerID, blinkerAPIPostsURL, pageType, blogURL, relatedPostsLimit);
    getFeaturedPosts(blinkerID, blinkerAPIFeaturedPostsURL, pageType, blogURL, featuredPostsLimit);
    getRelatedProducts(blinkerID, pageType, relatedProductsLimit);
  }

  /**
   * Get data from blinker
   */
  function blinkerGetRequest(blinker_id, blinker_url, page_type, blog_url, limit, callback) {
    const httpRequest = new XMLHttpRequest();

    httpRequest.onreadystatechange = function () {

      // Only run if the request is complete
      if (httpRequest.readyState !== 4) return;

      // Process our return data
      if (httpRequest.status >= 200 && httpRequest.status < 300) {
        let response = JSON.parse(httpRequest.responseText);

        if (response != 'undefined' && response != null) {
          return callback(page_type, blog_url, limit, response);
        } else {
          console.log('Blinker: Empty repsonse');
        }
      } else {
        // This will run when it's not
        console.log('Blinker: Request failed');
      }
    }

    if (limit != '') {
      httpRequest.open('GET', blinker_url + blinker_id + '&l=' + limit);
    } else {
      httpRequest.open('GET', blinker_url + blinker_id);
    }

    httpRequest.send();
  }

  /**
   * Get related blog posts data (on categories, brands, and products)
   */
  function getRelatedPosts(blinker_id, blinker_url, page_type, blog_url, limit) {
    if (page_type == 'product' || page_type == 'category' || page_type == 'brand') {
      blinkerGetRequest(blinker_id, blinker_url, page_type, blog_url, limit, processRelatedPosts);
    }
  }

  /**
   * Get featured blog posts data (e.g. on blog index)
   */
  function getFeaturedPosts(blinker_id, blinker_url, page_type, blog_url, limit) {
    if (page_type == 'blog') {
      // Load required glider css & js
      document.getElementsByTagName('head')[0].insertAdjacentHTML('beforeend', '<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/glider-js@1/glider.min.css" type="text/css" />');
      loadJS("//cdn.jsdelivr.net/npm/glider-js@1/glider.min.js", false);

      blinkerGetRequest(blinker_id, blinker_url, page_type, blog_url, limit, processFeaturedPosts);
    }
  }

  /**
   * Process related blog posts data (on categories, brands, and products)
   */
  function processRelatedPosts(page_type, blog_url, limit, data) {
    let relatedPosts = data;
    let target = document.getElementById('main-content').querySelector('.container');
    console.log('relatedPosts: ', relatedPosts);
    let postsHtml = '';

    postsHtml += `
      <div class="blinker-related-posts__container">
        <h3 class="blinker-related-posts__title">Related Blog Posts</h3>
        <div class="blinker-related-posts__grid">
    `;

    relatedPosts.slice(0, limit).forEach(post => {
      postsHtml += `
        <div class="blinker-related-posts__grid-cell">
          <div class="blinker-related-posts__post">
            <a class="blinker-related-posts__post-thumbnail" title="` + post.title + `" href="` + post.url + `" style="background-image: url(` + post.thumbnail_path + `);"></a>
            <h5 class="blinker-related-posts__post-title"><a title="` + post.title + `" href="` + post.url + `">` + post.title + `</a></h5>
            <a class="blinker-related-posts__post-link" title="` + post.title + `" href="` + post.url + `">Read More</a>
          </div>
        </div>
      `;
    });

    postsHtml += `
        </div>
        <h5 class="blinker-related-posts__blog-link"><a href="` + blog_url + `">More From The Blog</a><h5>
      </div>
    `;
    
    target.insertAdjacentHTML('beforeend', postsHtml);
  }

  /**
   * Process related blog posts data (on categories, brands, and products)
   */
  function processFeaturedPosts(page_type, blog_url, limit, data) {
    let featuredPosts = data;
    console.log('featuredPosts: ', featuredPosts);
    let target = document.querySelector('.page').querySelector('.page-heading');

    let postsHtml = '';

    target.insertAdjacentHTML('afterend', `
      <div class="glider-contain blinker-featured-posts-carousel heroCarousel">
        <div class="glider-wrap">
          <div id="js-blinker-featured-posts-carousel" class="glider"></div>
          <button id="glider-prev" class="slick-prev slick-arrow" aria-label="Previous" type="button">Previous</button>
          <button id="glider-next" class="slick-next slick-arrow" aria-label="Next" type="button">Next</button>
          <div id="dots" class="dots slick-dots" role="tablist"></div>
        </div>
      </div>
    `);

    let carouselDiv = document.getElementById("js-blinker-featured-posts-carousel");
    let featuredPostsHtml = ``;

    featuredPosts.slice(0, limit).forEach((featuredPost, i) => {
      featuredPostsHtml += `
        <div data-hero-slide="` + i + `">
          <div class="heroCarousel-slide" style="display:block!important;">
            <a href="` + featuredPost.url + `" class="">
              <div class="blinker-featured-post__image" style="background-image: url(` + featuredPost.thumbnail_path + `);"></div>
            </a>
            <div class="heroCarousel-content">
              <p class="heroCarousel-title">` + featuredPost.title + `</p>
              <a href="` + featuredPost.url + `" class="heroCarousel-action button button--primary button--large">Read Post</a>
            </div>
          </div>
        </div>
      `;
    });

    carouselDiv.insertAdjacentHTML('afterbegin', featuredPostsHtml);

    window.addEventListener('load', function() {
      new Glider(document.querySelector('.glider'), {
        slidesToShow: 1,
        dots: '#dots',
        arrows: {
          prev: '.slick-prev',
          next: '.slick-next'
        },
      });
    });

    // Fix for hiding the scrollbar on the carousel in firefox
    document.addEventListener('glider-loaded', hideFFScrollBars);
    document.addEventListener('glider-refresh', hideFFScrollBars);
    function hideFFScrollBars(e){
      var scrollbarHeight = 17; // Currently 17, may change with updates
      if(/firefox/i.test(navigator.userAgent)){
        // We only need to appy to desktop. Firefox for mobile uses
        // a different rendering engine (WebKit)
        if (window.innerWidth > 575){
          e.target.parentNode.style.height = (e.target.offsetHeight - scrollbarHeight) + 'px'
        }
      }
    }
  }

  /**
   * Get related products (on blog posts)
   */
  function getRelatedProducts(blinker_id, page_type, limit) {
    if (page_type == 'blog_post') {
      let httpRequestGetRelatedProducts = new XMLHttpRequest();

      httpRequestGetRelatedProducts.onreadystatechange = function () {

        // Only run if the request is complete
        if (httpRequestGetRelatedProducts.readyState !== 4) return;

        // Process our return data
        if (httpRequestGetRelatedProducts.status >= 200 && httpRequestGetRelatedProducts.status < 300) {
          // let relatedProducts = JSON.parse(httpRequestGetRelatedProducts.responseText);
          // Mock related products data
          let relatedProducts = [
            {
              "id": "201",
              "url": "https://lim.mybigcommerce.com/all-purpose-cleaner.html",
              "name": "All Purpose Cleaner",
              "price": "£18.00",
              "imgsrc": "https://cdn11.bigcommerce.com/s-mxw8ttfcei/images/stencil/500x659/products/201/413/CommonGoodAllPurposeCleaner_d37aa1e8_e16f_4309_bddd_8fae0d94efc7_1024x1024__40180.1456436663__46470.1643800796.jpg"
            },
            {
              "id": "200",
              "url": "https://lim.mybigcommerce.com/hand-soap.html",
              "name": "Hand Soap",
              "price": "£18.00",
              "imgsrc": "https://cdn11.bigcommerce.com/s-mxw8ttfcei/images/stencil/500x659/products/200/410/CommonGoodHandSoap_1024x1024__94874.1456436671__71182.1643800766.jpg"
            },
            {
              "id": "198",
              "url": "https://lim.mybigcommerce.com/canvas-laundry-cart.html",
              "name": "Canvas Laundry Cart",
              "price": "£298.80",
              "imgsrc": "https://cdn11.bigcommerce.com/s-mxw8ttfcei/images/stencil/500x659/products/198/404/naturalcanvascart2_1024x1024__92347.1456436682__86852.1643800646.jpg"
            },
            {
              "id": "197",
              "url": "https://lim.mybigcommerce.com/utility-caddy.html",
              "name": "Utility Caddy",
              "price": "£55.20",
              "imgsrc": "https://cdn11.bigcommerce.com/s-mxw8ttfcei/images/stencil/500x659/products/197/401/utilitybucket1_1024x1024__78563.1456436713__98353.1643800602.jpg"
            },
            {
              "id": "196",
              "url": "https://lim.mybigcommerce.com/s-shaped-scrub-brush.html",
              "name": "S Shaped Scrub Brush",
              "price": "£20.40",
              "imgsrc": "https://cdn11.bigcommerce.com/s-mxw8ttfcei/images/stencil/500x659/products/196/399/SshapedScrubBrush2_1024x1024__94308.1456436686__91379.1643800005.jpg"
            }
          ];
          console.log('relatedProducts: ', relatedProducts);
          let target = document.querySelector('.blog-post-body');

          if (relatedProducts != 'undefined' && relatedProducts != null) {
            target.insertAdjacentHTML('afterend', '<h3 class="blinker-related-products__title">Related Products</h3><ul id="js-product-grid" class="productGrid"></ul>');

            let productGridDiv = document.getElementById("js-product-grid");
            let relatedProductsHtml = '';

            relatedProducts.slice(0, limit).forEach(product => {
              relatedProductsHtml += `
                <li class="product">
                  <article class="card">
                    <figure class="card-figure">
                      <a href="` + product.url + `" class="card-figure__link" aria-label="` + product.name + `, ` + product.price + `">
                        <div class="card-img-container">
                          <img src="` + product.imgsrc + `" alt="` + product.name + `" title="` + product.name + `" class="card-image lazyloaded">
                        </div>
                      </a>
                    </figure>
                    <div class="card-body">
                      <h3 class="card-title">
                        <a aria-label="` + product.name + `, ` + product.price + `" href="` + product.url + `">` + product.name + `</a>
                      </h3>
                      <div class="card-text" data-test-info-type="price">
                        <div class="price-section">
                          <span class="price">` + product.price + `</span>
                        </div>
                      </div>
                    </div>
                  </article>
                </li>
              `;
            });

            productGridDiv.insertAdjacentHTML('afterbegin', relatedProductsHtml);

          } else {
            console.log('Blinker: Related products - None found');
          }
        } else {
          // This will run when it's not
          console.log('Blinker: The request failed!');
        }
      }

      // $.get('https://blinker.gpmd.net/products?h=' + id + '&u=' + document.location.href, null, (products) => {
      httpRequestGetRelatedProducts.open('GET', 'https://blinker.gpmd.net/products?h=' + blinker_id + '&u=' + document.location.href);
      httpRequestGetRelatedProducts.send();
    }
  }

  document.addEventListener('DOMContentLoaded', function(event) {
    initBlinker();
  });
</script>
